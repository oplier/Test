var CACHE_STORAGE={LOCAL_STORAGE:"local_storage",COOKIE:"cookie",NONE:"none"},CACHE_POLICY={ALWAYS_RETURN_FROM_CACHE:"always",ON_HIT_RETURN_FROM_CACHE:"on_hit",NEVER_RETURN_FROM_CACHE:"never"},TapestryClient=function(e){function t(e){return"function"==typeof e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}function n(){return r()+r()+r()+r()+r()+r()+r()+r()}function r(){return(0|65536*(1+Math.random())).toString(16).substring(1)}function o(){function e(){E.cache_storage===CACHE_STORAGE.COOKIE?p.setCookie(h,t(i),void 0,"/"):E.cache_storage===CACHE_STORAGE.LOCAL_STORAGE&&"object"==typeof localStorage&&localStorage.setItem(h,t(i))}function t(e){for(var t in e)a>e[t][0]&&-1!=e[t][0]&&delete e[t];for(;o.cookieEncode(JSON.stringify(e)).length>E.cache_max_size_in_bytes;){var r=n(e);if(null===r)return e;delete e[r]}return o.cookieEncode(JSON.stringify(e))}function n(e){var t=null,n=0;for(var r in e){var o=JSON.stringify(e[r]).length;o>n&&(n=o,t=r)}return t}function r(e){for(var t=0,n=0;e.length>n;n++){var r=e.charCodeAt(n);t=(t<<5)-t+r,t&=t}return t}var o=this,i={},a=Math.floor((new Date).getTime()/1e3/60),c={ids:0,data:1,audiences:2,devices:3,errors:4,sync:5,syncServerTime:6},s={};for(var d in c)s[c[d]]=d;this.loadFromStorage=function(){var e=null;E.cache_storage===CACHE_STORAGE.COOKIE?e=p.getCookie(h):E.cache_storage===CACHE_STORAGE.LOCAL_STORAGE&&"object"==typeof localStorage&&(e=localStorage.getItem(h)),"string"==typeof e&&(i=JSON.parse(o.cookieDecode(e))),t(i)},this.put=function(t,n,c){c=c||a+E.cache_expiry_in_minutes,i[r(t)]=[c,o.compressResponse(n)],e()},this.lookup=function(e){var t=i[r(e)];return"object"==typeof t?o.decompressResponse(t[1]):void 0},this.cookieDecode=function(e){return decodeURIComponent(e.replace(/=/g,'"').replace(/#/g,","))},this.cookieEncode=function(e){return encodeURIComponent(e).replace(/%5B/g,"[").replace(/%5D/g,"]").replace(/%7B/g,"{").replace(/%7D/g,"}").replace(/%2C/g,"#").replace(/%22/g,"=").replace(/%3A/g,":")},this.compressResponse=function(e){if("object"!=typeof e)return e;var t=[];for(var n in e){var r=c[n];r===void 0?t.push(n):t.push(r),t.push(e[n])}return t},this.decompressResponse=function(e){if("object"!=typeof e)return e;for(var t={},n=0;e.length>n;n+=2){var r=e[n],o=e[n+1],i=s[r];i===void 0?t[r]=o:t[i]=o}return t}}function i(e){Y.push({key:e,paramEncoder:R(e,O)})}function a(e){for(var t=[],n=0;Y.length>n;n++)if(Y[n].key){var r=Y[n].paramEncoder(e[Y[n].key]);t.push(r)}return t.join("&")}function c(e){if("function"==typeof f&&f(e),!_){p.logger.debug("request "+e);var t=document.createElement("script");t.type="text/javascript",t.src=e,t.async=!0;var n=document.getElementsByTagName("script")[0];t.onload=t.onreadystatechange=function(){if(!t.readyState||"complete"===t.readyState||"loaded"===t.readyState){t.onload=t.onreadystatechange=null;try{n.parentNode.removeChild(t)}catch(e){if(p.logger.error(e),g)throw e}}},n.parentNode.appendChild(t)}}function s(e){return u(e),p.partnerParam()+B(p.partnerDeviceIdParam(e.did))+B(D(e.remove_audiences))+B(x(e.sadd_data))+B(U(e.remove_data))+B(H(e.clear_data))+B(T(e.depth))+B(k(e.strength))+B(I(e.set_data))+B(L(e.add_audiences))+B(b(e.user_ids))+B(N(e.bridge))+B(S(e.add_data))+B(P(e.typed_did))+B(G(e.sync))+B(d())+B(a(e))}function d(){return"ta_js_version="+l}function u(e){var t=p.getCookie(y);null===t&&(t=n()),p.setCookie(y,t,2592e3,"/"),"object"!=typeof e.typed_did&&(e.typed_did={}),e.typed_did.fpc=t}var l="0.7.2",p=this;e=e||{};var g=!!e.debug,_=!!e.noRequest,f=e.before,h="TAJ",y="TAJc",v="s",m="http://assets.tapad.com/tapestry/sync.html";p.cache=new o;var C={protocol:document.location.protocol,host:"tapestry.tapad.com",port:null,version:1},E={cache_policy:CACHE_POLICY.ON_HIT_RETURN_FROM_CACHE,cache_storage:CACHE_STORAGE.COOKIE,cache_expiry_in_minutes:180,cache_max_size_in_bytes:1e3};this.logger={debug:function(){"undefined"!=typeof console&&"function"==typeof console.log&&g&&console.log(arguments)},log:function(){"undefined"!=typeof console&&"function"==typeof console.log&&console.log(arguments)},warn:function(){"undefined"!=typeof console&&"function"==typeof console.warn&&(g?console.warn(arguments):p.logger.log(arguments))},error:function(){"undefined"!=typeof console&&"function"==typeof console.error&&(g?console.error(arguments):p.logger.log(arguments))}},this.apiBase=function(){var e=null===C.port?"":":"+C.port;return C.protocol+"//"+C.host+e+"/tapestry"+(C.version?"/"+C.version:"")},this.partnerId=null,this.currentPartnerDeviceId=null,this.partnerParam=function(){return"ta_partner_id="+encodeURIComponent(this.partnerId)},this.partnerDeviceIdParam=function(e){return e===void 0&&this.currentPartnerDeviceId?"ta_partner_did="+encodeURIComponent(this.currentPartnerDeviceId):e?"ta_partner_did="+encodeURIComponent(e):""};var R=function(e,t){return function(n){return n===void 0?"":"ta_"+e+t(n)}},O=function(e){return""==e||null==e?"":"string"==typeof e?"="+encodeURIComponent(e):JSON?"="+encodeURIComponent(JSON.stringify(e)):(p.logger.error("JSON is required. Skipping parameter "+e),"")},w=function(e){return"="+(parseInt(e,10)||0)},A=function(){return""},b=R("partner_user_id",O),S=R("add_data",O),I=R("set_data",O),T=R("depth",w),k=R("strength",w),N=R("bridge",O);R("get_devices",A);var H=R("clear_data",A),U=R("remove_data",O),x=R("sadd_data",O),D=R("remove_audiences",O),L=R("add_audiences",O),P=R("typed_did",O),j=R("get",A),G=R("sync",function(){var e=p.cache.lookup(v);return e===void 0?"=0":"="+e});this.getCookie=function(e){for(var n=document.cookie.split(";"),r=0;n.length>r;r++){var o=t(n[r]);if(0==o.indexOf(e+"="))return o.substring(e.length+1,o.length)}return null},this.setCookie=function(e,t,n,r,o,i){var a=new Date;document.cookie=e+"="+t+(n?";expires="+new Date(a.getTime()+1e3*n).toUTCString():"")+(r?";path="+r:"")+(o?";domain="+o:"")+(i?";secure":"")};var J=function(e,t){p.logger.debug("sync "+e);var n=document.createElement("iframe");n.setAttribute("src",m+"?"+e),n.name="tapestry_id_sync_frame",n.style.width="0",n.style.height="0",n.style.display="none",n.style.tabindex="-1",n.onload=n.onreadystatechange=function(){p.setLastSyncTimestamp(t)},document.body.appendChild(n)};this.setLastSyncTimestamp=function(e){p.cache.put(v,e,-1)};var z=function(e){var t=[];for(var n in e)t.push(n+"="+encodeURIComponent(e[n]));return t.join("&")},F=function(e){var t=e.callback,r="_tapestry_callback_"+n();return window[r]=function(n){try{p.cache.put(s(e),n),"function"==typeof t?t(n):"string"==typeof t&&window[t](n),"object"==typeof n.sync&&J(z(n.sync),n.syncServerTime),n.ids&&n.ids.tpc&&1==n.ids.tpc.length&&p.setCookie(y,n.ids.tpc[0],2592e3,"/");try{delete window[r]}catch(o){window[r]=void 0}}catch(o){if(p.logger.error(o),g)throw o}},r},M=function(){return"cachebuster="+n()},Y=[],B=function(e){return 0===e.length?"":"&"+e};this.push=function(e){try{if(e.initialize&&(this.partnerId=e.initialize),e.identify&&(this.currentPartnerDeviceId=e.identify),e.configure&&(C.host=e.configure.host||C.host,C.port=e.configure.port||C.port,C.version=e.configure.version||C.version,m=e.configure.syncUrl||m,g=g||!!e.configure.debug,p.logger.debug("Tapestry debug mode is enabled. Errors will be logged and thrown, and additional data will be logged."),E.cache_policy=e.configure.cache_policy||E.cache_policy,E.cache_storage=e.configure.cache_storage||E.cache_storage,E.cache_expiry_in_minutes=e.configure.cache_expiry_in_minutes||E.cache_expiry_in_minutes,E.cache_max_size_in_bytes=e.configure.cache_max_size_in_bytes||E.cache_max_size_in_bytes,p.cache.loadFromStorage(E),e.configure.register_plugins))for(var t=0;e.configure.register_plugins.length>t;t++)i(e.configure.register_plugins[t]);if(!this.partnerId)return p.logger.log("Tapestry Partner ID is not configured. Try tapestry.push({'initialize':'yourPartnerId'})"),void 0;if(s(e).length==s({}).length&&e.callback===void 0)return;var n=F(e),r=s(e)+B("ta_callback="+n)+B(M())+B(j(e.callback)),o=this.apiBase()+"?"+r,a=p.cache.lookup(s(e)),d=function(t){p.cache.put(s(e),t)},u=e.cache_policy||E.cache_policy;a!==void 0&&u!==CACHE_POLICY.NEVER_RETURN_FROM_CACHE?(window[n](a),window[n]=d):u===CACHE_POLICY.ALWAYS_RETURN_FROM_CACHE&&(window[n]({}),window[n]=d),c(o)}catch(l){if(p.logger.error("Error calling TapestryClient",l),g)throw l}}},_tapestry_initialEvents=window._tapestry||[];window._tapestry=new TapestryClient;for(var i=0;_tapestry_initialEvents.length>i;i++)window._tapestry.push(_tapestry_initialEvents[i]);
